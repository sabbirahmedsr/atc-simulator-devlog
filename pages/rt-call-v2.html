<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT Call - V2</title>    
    <link rel="icon" href="../image/fav-icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/rt-call-style-v2.css">
</head>
<body>

    <div class="header-container">
        <h1>ATC Simulator - RT Calls (V2)</h1>
        <div class="header-btn-group">
            <button id="params-btn" title="View All Parameters"><i class="fa-solid fa-list-ul"></i></button>
            <button id="help-btn" title="Recording Instructions"><i class="fa-solid fa-comment-dots"></i></button>
            <button id="print-btn" title="Print as PDF"><i class="fa-solid fa-print"></i></button>
        </div>
    </div>

    <div class="filter-container">
        <div class="filter-group">
            <label>Airport:</label>
            <button class="filter-btn active" data-filter-group="icao" data-filter-value="vghs">VGHS</button>
            <button class="filter-btn" data-filter-group="icao" data-filter-value="vgjr">VGJR</button>
        </div>
        <div class="filter-group">
            <label for="aircraft-filter">Aircraft:</label>
            <div class="aircraft-select-wrapper">
                <select id="aircraft-filter">
                    <option value="all">All</option>
                </select>
            </div>
        </div>
        <div class="filter-group">
            <label for="callsign-filter">Call Sign:</label>
            <input type="text" id="callsign-filter" value="call-sign">
        </div>
        <div class="filter-group">
            <label>Type:</label>
            <button class="filter-btn active" data-filter-group="type" data-filter-value="arrival">Arrival</button>
            <button class="filter-btn" data-filter-group="type" data-filter-value="departure">Departure</button>
            <button class="filter-btn" data-filter-group="type" data-filter-value="circuit">Circuit</button>
        </div>
    </div>

    <div id="rt-call-container">
        <!-- RT Calls will be loaded here -->
    </div>

    <!-- Help/Instructions Popup -->
    <div class="popup-overlay" id="help-popup">
        <div class="popup-content">
            <h3>Voice Recording Guidelines</h3>
            <ul class="instruction-list">
                <li><strong>Pause for Variables:</strong> Pause briefly before and after reading any text in <code>{curly brackets}</code>. This helps the audio editor splice the recordings cleanly.</li>
                <li><strong>Standalone Delivery:</strong> Read each line as a separate, new radio call. Avoid a conversational flow and maintain a formal tone.</li>
                <li><strong>Enunciate Clearly:</strong> Pronounce every word distinctly. Pay special attention to the first and last word of each phrase to ensure the full instruction is understood.</li>
            </ul>
        </div>
    </div>

    <!-- Parameters Popup -->
    <div class="popup-overlay" id="params-popup">
        <div class="popup-content">
            <h3>Parameters in Context</h3>
            <div id="params-content-container">
                <!-- Parameters will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Container for printing RT calls, hidden by default -->
    <div id="print-rt-call-container"></div>

    <!-- Container for printing parameters, hidden by default -->
    <div id="print-params-container"></div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainTitle = document.querySelector('h1');
            const container = document.getElementById('rt-call-container');
            const aircraftFilter = document.getElementById('aircraft-filter');
            const callsignFilter = document.getElementById('callsign-filter');
            let allRtCallData = []; // To store all fetched data
            let allParameters = {}; // To store parameter data

            async function fetchAllData() {
                const urlParams = new URLSearchParams(window.location.search);
                const icaoParam = urlParams.get('icao');

                let dataPath = '../data/rt-call-v2'; // Default path
                if (icaoParam === 'vgjr') {
                    dataPath = '../data/rt-call-vgjr';
                } else if (icaoParam === 'vghs') {
                    dataPath = '../data/rt-call-vghs';
                }

                // Update filter buttons based on URL param
                const icaoButtons = document.querySelectorAll('.filter-btn[data-filter-group="icao"]');
                icaoButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (icaoParam && btn.dataset.filterValue === icaoParam) {
                        btn.classList.add('active');
                    } else if (!icaoParam && btn.dataset.filterValue === 'vghs') { // Default to VGHS if no param
                        btn.classList.add('active');
                    }
                });

                const filesToFetch = [
                    `${dataPath}/arrival-rt-call-data.json`,
                    `${dataPath}/departure-rt-call-data.json`,
                    `${dataPath}/circuit-rt-call-data.json`
                ];

                try {
                    const filePromises = filesToFetch.map(fileUrl => {
                        const type = fileUrl.split('/').pop().split('-')[0]; // 'arrival', 'departure', etc.
                        return fetch(fileUrl)
                            .then(res => {
                                if (!res.ok) return []; // If a file doesn't exist, return an empty array
                                return res.json().then(data => data.map(item => ({ ...item, type })));
                            })
                            .catch(() => []); // On network error, also return an empty array
                    });

                    // Also fetch the parameters file
                    const paramsPromise = fetch(`${dataPath}/all-parameter-data.json`)
                        .then(res => res.ok ? res.json() : {})
                        .catch(() => ({}));

                    const [results, paramsData] = await Promise.all([Promise.all(filePromises), paramsPromise]);
                    
                    allRtCallData = results.flat(); // Flatten the array of arrays
                    allParameters = paramsData; // Store parameters
                    
                    populateAircraftFilter();
                    renderCalls();
                } catch (error) {
                    console.error('Error processing RT call data:', error);
                    container.innerHTML = '<p style="text-align:center;">Error: Could not process RT call data.</p>';
                }
            }

            function populateAircraftFilter() {
                const activeIcao = document.querySelector('.filter-btn[data-filter-group="icao"].active').dataset.filterValue;

                const aircraftDataByIcao = {
                    vghs: {
                        "CIVIL": ["B777", "B787", "A320", "A330", "Dash8Q", "ATR72"],
                        "Military Jet": ["MIG29", "F7"],
                        "Military Transport": ["AN32", "C130"],
                        "Helicopter": ["R66"]
                    },
                    vgjr: {
                        "CIVIL": ["ATR72"],
                        "Military Jet": ["K8"],
                        "Military Trainer": ["PT6", "GROB120"],
                        "Helicopter": ["BELL206", "AW119"]
                    }
                };

                aircraftFilter.innerHTML = '<option value="all">All</option>'; // Reset

                const aircraftForIcao = aircraftDataByIcao[activeIcao];

                if (aircraftForIcao) {
                    for (const category in aircraftForIcao) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = category;

                        aircraftForIcao[category].forEach(aircraftModel => {
                            const option = document.createElement('option');
                            option.value = aircraftModel;
                            option.textContent = aircraftModel;
                            optgroup.appendChild(option);
                        });

                        aircraftFilter.appendChild(optgroup);
                    }
                } else {
                    // Fallback for old data structure if needed
                    const allAircraft = new Set(allRtCallData.flatMap(call => call.aircraft || []));
                    [...allAircraft].sort().forEach(ac => aircraftFilter.add(new Option(ac, ac)));
                }
            }

            function formatMessageWithVariables(message) {
                const activeCallsign = callsignFilter.value || 'call-sign';
                // A list of variables that should have the subtle style.
                // We check for "Call Sign" and common ATC identifiers.
                const subtleVariables = ["Call Sign", "DHK TWR", "DHK GRD", "JSR TWR", "JSR GRD"];

                return message.replace(/{([^}]+)}/g, (match, variableName) => {
                    // Trim the variable name to be safe
                    const trimmedVar = variableName.trim();

                    // Check if the variable name is in our subtle list
                    if (subtleVariables.includes(trimmedVar) || trimmedVar === activeCallsign) {
                        // Apply the subtle class
                        return `<span class="variable-subtle">${match}</span>`;
                    } else {
                        // Apply the high-contrast class for all other variables
                        return `<span class="variable-contrast">${match}</span>`;
                    }
                });
            }

            function renderCalls() {
                container.innerHTML = ''; // Clear previous results

                const activeType = document.querySelector('.filter-btn[data-filter-group="type"].active').dataset.filterValue;
                const activeIcao = document.querySelector('.filter-btn[data-filter-group="icao"].active').dataset.filterValue;
                const activeAircraft = aircraftFilter.value;
                const activeCallsign = callsignFilter.value || 'call-sign'; // Use default if empty

                // Map specific aircraft models to their general categories
                const aircraftToCategoryMap = {
                    // VGHS
                    "B777": "Civil", "B787": "Civil", "A320": "Civil", "A330": "Civil", "Dash8Q": "Civil", "ATR72": "Civil",
                    "MIG29": "Military Jet", "F7": "Military Jet",
                    "AN32": "Military Transport", "C130": "Military Transport",
                    "R66": "Helicopter",
                    // VGJR
                    "K8": "Military Jet",
                    "PT6": "Military Trainer", "GROB120": "Military Trainer",
                    "BELL206": "Helicopter", "AW119": "Helicopter"
                };

                // --- Update Main Title ---
                const displayAircraft = activeAircraft === 'all' ? 'All Aircraft' : activeAircraft.toUpperCase();
                const displayType = activeType.charAt(0).toUpperCase() + activeType.slice(1);
                mainTitle.textContent = `${activeIcao.toUpperCase()} - ${displayAircraft} - {${activeCallsign}} - ${displayType} - RT CALL`;
                // --- End Title Update ---

                const baseFilteredData = allRtCallData.filter(data => {
                    const typeMatch = data.type === activeType;
                    const icaoMatch = true; // ICAO is filtered by folder, so this is always true here.

                    // --- New Aircraft Filtering Logic ---
                    let aircraftMatch = false;
                    if (activeAircraft === 'all') {
                        aircraftMatch = true;
                    } else if (data.aircraft) {
                        // Get the category for the selected aircraft (e.g., "B777" -> "Civil")
                        const categoryOfSelectedAircraft = aircraftToCategoryMap[activeAircraft];
                        // Match if the call's aircraft list includes the specific model OR its general category
                        aircraftMatch = data.aircraft.includes(activeAircraft) || (categoryOfSelectedAircraft && data.aircraft.includes(categoryOfSelectedAircraft));
                    }

                    return typeMatch && icaoMatch && aircraftMatch;
                });

                // Group the filtered data by category
                const groupedByCategory = baseFilteredData.reduce((acc, call) => {
                    const category = call.category || 'Uncategorized';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(call);
                    return acc;
                }, {});

                // Get the unique categories while preserving the order from the source file
                const orderedCategories = [];
                const categorySet = new Set();
                baseFilteredData.forEach(call => {
                    const category = call.category || 'Uncategorized';
                    if (!categorySet.has(category)) {
                        categorySet.add(category);
                        orderedCategories.push(category);
                    }
                });

                if (orderedCategories.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No matching RT calls found.</p>';
                    return;
                }

                const createCard = (data, index) => {
                    const card = document.createElement('div');
                    card.className = 'rt-card';

                    // Dynamically replace placeholders based on the selected airport
                    const processedCalls = data.calls.map(call => {
                        let { speaker, message } = call;
                        const callsignRegex = /{Call Sign}/gi;

                        if (activeIcao === 'vghs') {
                            message = message.replace(/{GRD}|{GND}/g, '{DHK GRD}').replace(/{TWR}/g, '{DHK TWR}');
                        } else if (activeIcao === 'vgjr') {
                            message = message.replace(/{GRD}|{GND}/g, '{JSR GRD}').replace(/{TWR}/g, '{JSR TWR}');
                        }
                        message = message.replace(callsignRegex, `{${activeCallsign}}`);

                        return { speaker, message: formatMessageWithVariables(message) };
                    });

                    const dialogueRows = processedCalls.map(call => `
                        <div class="call-row" data-speaker="${call.speaker}">
                            <span class="speaker">${call.speaker}:</span>
                            <p class="call-text">${call.message || '...'}</p>
                        </div>
                    `).join('');


                    const aircraftListItems = data.aircraft ? data.aircraft.map(ac => `<li>${ac}</li>`).join('') : '<li>N/A</li>';
                    const aircraftPopupId = `aircraft-popup-${index}`;
                    const descPopupId = `desc-popup-${index}`;

                    // --- Create Aircraft Symbols Dynamically ---
                    const getAircraftSymbol = (name) => {
                        if (!name) return '';
                        // For specific models that shouldn't be shortened
                        if (["PT6", "K8", "F7", "R66", "AN32", "C130", "MIG29", "BELL206", "AW119", "GROB120"].includes(name.toUpperCase())) {
                            return name;
                        }
                        // For multi-word names like "Military Jet" -> "MJ"
                        if (name.includes(' ')) {
                            return name.split(' ').map(word => word[0]).join('').toUpperCase();
                        }
                        // For single-word names like "Civil" -> "C"
                        return name[0].toUpperCase();
                    };

                    card.innerHTML = `
                        <div class="details-btn-container">
                            <button class="details-btn" data-popup-target="#${descPopupId}" title="View Details">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                        </div>
                        <div class="phase-column">
                            <h2>${(data.phase || 'N/A').replace(/_/g, ' ')}</h2>
                        </div>
                        <div class="dialogue-column">${dialogueRows}</div>
                        <div class="aircraft-symbols-top-container">
                             ${(data.aircraft || []).map(ac => `<span class="aircraft-symbol" title="${ac}">${getAircraftSymbol(ac)}</span>`).join('')}
                        </div>
                        <div class="popup-overlay" id="${descPopupId}">
                            <div class="popup-content">
                                <h3 style="text-transform: capitalize;">${(data.phase || 'Description').replace(/_/g, ' ')}</h3>
                                <p>${data.description || 'No description available.'}</p>
                                <h3 class="popup-section-header">Applicable Aircraft</h3>
                                <ul>${aircraftListItems}</ul>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                };

                let globalIndex = 0;
                orderedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'category-header';
                    categoryHeader.textContent = category.toUpperCase();
                    container.appendChild(categoryHeader);

                    const callsInCategory = groupedByCategory[category];
                    callsInCategory.forEach(callData => {
                        createCard(callData, globalIndex++);
                    });
                });
            }

            function prepareRtCallsForPrint() {
                const printContainer = document.getElementById('print-rt-call-container');
                printContainer.innerHTML = ''; // Clear previous content

                const activeIcao = document.querySelector('.filter-btn[data-filter-group="icao"].active').dataset.filterValue;
                const activeAircraft = aircraftFilter.value;
                const activeCallsign = callsignFilter.value || 'call-sign';

                const callTypesToPrint = ['arrival', 'departure', 'circuit'];

                callTypesToPrint.forEach(callType => {
                    const typeFilteredData = allRtCallData.filter(data => {
                        const typeMatch = data.type === callType;
                        // We still respect the ICAO (folder) and Aircraft filters for the print version
                        const aircraftMatch = activeAircraft === 'all' || (data.aircraft && data.aircraft.includes(activeAircraft));
                        return typeMatch && aircraftMatch;
                    });

                    if (typeFilteredData.length > 0) {
                        // Add a main header for the call type (e.g., "Arrival Calls")
                        const typeHeader = document.createElement('h1');
                        
                        // --- Create dynamic page title for print ---
                        const displayAircraft = activeAircraft === 'all' ? 'All Aircraft' : activeAircraft.toUpperCase();
                        const displayType = callType.charAt(0).toUpperCase() + callType.slice(1);
                        const pageTitle = `${activeIcao.toUpperCase()} - ${displayAircraft} - {${activeCallsign}} - ${displayType} - RT CALL`;
                        typeHeader.textContent = pageTitle;
                        // --- End title creation ---

                        // Start each new section on a new page
                        typeHeader.style.pageBreakBefore = 'always'; 
                        if (callType === 'arrival') {
                            typeHeader.style.pageBreakBefore = 'auto'; // Don't break before the very first one
                        }
                        printContainer.appendChild(typeHeader);

                        const groupedByCategory = typeFilteredData.reduce((acc, call) => {
                            const category = call.category || 'Uncategorized';
                            if (!acc[category]) acc[category] = [];
                            acc[category].push(call);
                            return acc;
                        }, {});

                        const orderedCategories = [];
                        const categorySet = new Set();
                        typeFilteredData.forEach(call => {
                            const category = call.category || 'Uncategorized';
                            if (!categorySet.has(category)) {
                                categorySet.add(category);
                                orderedCategories.push(category);
                            }
                        });

                        orderedCategories.forEach(category => {
                            const categoryHeader = document.createElement('h3');
                            categoryHeader.className = 'category-header';
                            categoryHeader.textContent = category.toUpperCase();
                            printContainer.appendChild(categoryHeader);

                            groupedByCategory[category].forEach(data => {
                                const card = document.createElement('div');
                                card.className = 'rt-card';

                                const processedCalls = data.calls.map(call => {
                                    let { speaker, message } = call;
                                    const callsignRegex = /{Call Sign}/gi;
                                    if (activeIcao === 'vghs') {
                                        message = message.replace(/{GRD}|{GND}/g, '{DHK GRD}').replace(/{TWR}/g, '{DHK TWR}');
                                    } else if (activeIcao === 'vgjr') {
                                        message = message.replace(/{GRD}|{GND}/g, '{JSR GRD}').replace(/{TWR}/g, '{JSR TWR}');
                                    }
                                    message = message.replace(callsignRegex, `{${activeCallsign}}`);
                                    return { speaker, message };
                                });

                                const dialogueRows = processedCalls.map(call => `
                                    <div class="call-row" data-speaker="${call.speaker}">
                                        <span class="speaker">${call.speaker}:</span>
                                        <p class="call-text">${call.message || '...'}</p>
                                    </div>`).join('');

                                card.innerHTML = `<div class="dialogue-column">${dialogueRows}</div>`;
                                printContainer.appendChild(card);
                            });
                        });
                    }
                });
            }

            async function renderParametersPopup() {
                const paramsContainer = document.getElementById('params-content-container');
                const paramsData = allParameters; // Use stored parameters
                if (Object.keys(paramsData).length === 0) {
                    paramsContainer.innerHTML = '<p>No parameters loaded.</p>';
                    return;
                }

                const activeCallsign = callsignFilter.value || 'call-sign';
                let html = '';
                const callsignRegex = /{Call Sign}/gi;
                for (const key in paramsData) {
                    if (key === 'Call Sign') continue; // Skip call sign as it's used in the sentence

                    html += `<div class="param-group"><h4>${key}</h4>`;
                    const param = paramsData[key];
                    const prefix = param.prefix || '';
                    const suffix = param.suffix || '';

                    const sentences = param.values.map(value => {
                        const callsignPlaceholder = `{${activeCallsign}}`;

                        const phoneticReplace = (str) => {
                            return str.replace(/-/g, ' - ')
                                      .replace(/SA/g, 'South Alpha').replace(/HA/g, 'Hotel Alpha')
                                      .replace(/S1/g, 'Sierra One').replace(/S2/g, 'Sierra Two').replace(/S3/g, 'Sierra Three')
                                      .replace(/C/g, 'Charlie').replace(/F/g, 'Foxtrot').replace(/V/g, 'Victor')
                                      .replace(/N2/g, 'November Two').replace(/N-A-P/g, 'North Alpha - Papa').replace(/N-A/g, 'North Alpha');
                        }
                        
                        const finalPrefix = prefix.replace(callsignRegex, callsignPlaceholder);
                        const finalSuffix = suffix.replace(callsignRegex, callsignPlaceholder);
                        const paramValue = (key.toLowerCase().includes('taxiway')) ? phoneticReplace(value) : value;

                        return `<p class="param-sentence"><span class="param-prefix">${finalPrefix}</span><span class="param-value">${paramValue}</span><span class="param-suffix">${finalSuffix}</span></p>`;
                    }).join('');

                    html += `<div class="param-sentences-box">${sentences}</div></div>`;
                }
                paramsContainer.innerHTML = html;
            }

            async function prepareParametersForPrint() {
                const printContainer = document.getElementById('print-params-container');
                printContainer.innerHTML = ''; // Clear previous content
                const paramsData = allParameters; // Use stored parameters
                if (Object.keys(paramsData).length === 0) return;

                const activeCallsign = callsignFilter.value || 'call-sign';
                let html = '<h3>All Parameter Calls</h3>';
                const callsignRegex = /{Call Sign}/gi;
                for (const key in paramsData) {
                    if (key === 'Call Sign') continue;

                    html += `<h4>${key}</h4>`;
                    const param = paramsData[key];
                    const prefix = param.prefix || '';
                    const suffix = param.suffix || '';

                    const sentences = param.values.map(value => {
                        const callsignPlaceholder = `{${activeCallsign}}`;
                        const phoneticReplace = (str) => {
                            return str.replace(/-/g, ' - ')
                            .replace(/SA/g, 'South Alpha').replace(/HA/g, 'Hotel Alpha')
                            .replace(/S1/g, 'Sierra One').replace(/S2/g, 'Sierra Two').replace(/S3/g, 'Sierra Three')
                            .replace(/C/g, 'Charlie').replace(/F/g, 'Foxtrot').replace(/V/g, 'Victor')
                            .replace(/N2/g, 'November Two').replace(/N-A-P/g, 'North Alpha - Papa').replace(/N-A/g, 'North Alpha');
                        }

                        const finalPrefix = prefix.replace(callsignRegex, callsignPlaceholder);
                        const finalSuffix = suffix.replace(callsignRegex, callsignPlaceholder);
                        const paramValue = (key.toLowerCase().includes('taxiway')) ? phoneticReplace(value) : value;
                        const sentence = `<span class="print-param-prefix">${finalPrefix}</span><strong>${paramValue}</strong><span class="print-param-suffix">${finalSuffix}</span>`;
                        return `<p>${sentence}</p>`;
                    }).join('');

                    html += sentences;
                }
                printContainer.innerHTML = html;
            }

            function setupEventListeners() {
                // Use event delegation for filter buttons
                document.querySelector('.filter-container').addEventListener('click', (e) => {
                    if (e.target.matches('.filter-btn[data-filter-group]')) {
                        const btn = e.target;
                        const group = btn.dataset.filterGroup;
                        
                        // If an ICAO button is clicked, reload the page with the new parameter
                        if (group === 'icao') {
                            const icaoValue = btn.dataset.filterValue;
                            window.location.search = `?icao=${icaoValue}`;
                            return; // Stop further execution as the page will reload
                        }

                        document.querySelectorAll(`.filter-btn[data-filter-group="${group}"]`).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        renderCalls();
                    }
                });

                aircraftFilter.addEventListener('change', renderCalls);
                callsignFilter.addEventListener('input', renderCalls);

                // Event delegation for popups
                document.body.addEventListener('click', function(e) {
                    if (e.target.matches('.details-btn, .details-btn *')) {
                        const btn = e.target.closest('.details-btn');
                        const popup = document.querySelector(btn.dataset.popupTarget);
                        if (popup) popup.classList.add('visible');
                    }
                    if (e.target.matches('.popup-overlay')) {
                        e.target.classList.remove('visible');
                    }
                });
            }

            document.getElementById('print-btn').addEventListener('click', async () => {
                await prepareRtCallsForPrint(); // Prepare the full RT call list for printing
                await prepareParametersForPrint(); // Wait for parameters to be ready
                window.print(); // Then open the print dialog
            });

            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-popup').classList.add('visible');
            });

            document.getElementById('params-btn').addEventListener('click', () => {
                renderParametersPopup(); // Re-render with latest callsign
                document.getElementById('params-popup').classList.add('visible');
            });

            // Initial Load
            fetchAllData().then(setupEventListeners);
        });
    </script>

</body>
</html>
