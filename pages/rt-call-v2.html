<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT Call - V2</title>    
    <link rel="icon" href="../image/fav-icon.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/rt-call-style-v2.css">
</head>
<body>

    <div class="header-container">
        <h1>ATC Simulator - RT Calls (V2)</h1>
        <div class="header-btn-group">
            <button id="help-btn" title="Recording Instructions"><i class="fa-solid fa-comment-dots"></i></button>
            <button id="print-btn" title="Print as PDF"><i class="fa-solid fa-print"></i></button>
        </div>
    </div>

    <div class="filter-container">
        <div class="filter-group">
            <label>Airport:</label>
            <button class="filter-btn active" data-filter-group="icao" data-filter-value="vghs">VGHS</button>
            <button class="filter-btn" data-filter-group="icao" data-filter-value="vgjr">VGJR</button>
        </div>
        <div class="filter-group">
            <label for="aircraft-filter">Aircraft:</label>
            <div class="aircraft-select-wrapper">
                <select id="aircraft-filter">
                    <option value="all">All</option>
                </select>
            </div>
        </div>
        <div class="filter-group">
            <label for="callsign-filter">Call Sign:</label>
            <input type="text" id="callsign-filter" value="call-sign">
        </div>
        <div class="filter-group">
            <label>Type:</label>
            <button class="filter-btn active" data-filter-group="type" data-filter-value="arrival">Arrival</button>
            <button class="filter-btn" data-filter-group="type" data-filter-value="departure">Departure</button>
            <button class="filter-btn" data-filter-group="type" data-filter-value="circuit">Circuit</button>
        </div>
    </div>

    <div id="rt-call-container">
        <!-- RT Calls will be loaded here -->
    </div>

    <!-- Help/Instructions Popup -->
    <div class="popup-overlay" id="help-popup">
        <div class="popup-content">
            <h3>Voice Recording Guidelines</h3>
            <ul class="instruction-list">
                <li><strong>Pause for Variables:</strong> Pause briefly before and after reading any text in <code>{curly brackets}</code>. This helps the audio editor splice the recordings cleanly.</li>
                <li><strong>Standalone Delivery:</strong> Read each line as a separate, new radio call. Avoid a conversational flow and maintain a formal tone.</li>
                <li><strong>Enunciate Clearly:</strong> Pronounce every word distinctly. Pay special attention to the first and last word of each phrase to ensure the full instruction is understood.</li>
            </ul>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const mainTitle = document.querySelector('h1');
            const container = document.getElementById('rt-call-container');
            const aircraftFilter = document.getElementById('aircraft-filter');
            const callsignFilter = document.getElementById('callsign-filter');
            let allRtCallData = []; // To store all fetched data

            async function fetchAllData() {
                const filesToFetch = [
                    '../data/rt-call-v2/arrival-rt-call-data.json',
                    '../data/rt-call-v2/departure-rt-call-data.json',
                    '../data/rt-call-v2/circuit-rt-call-data.json'
                ];

                try {
                    const filePromises = filesToFetch.map(fileUrl => {
                        const type = fileUrl.split('/').pop().split('-')[0]; // 'arrival', 'departure', etc.
                        return fetch(fileUrl)
                            .then(res => {
                                if (!res.ok) return []; // If a file doesn't exist, return an empty array
                                return res.json().then(data => data.map(item => ({ ...item, type })));
                            })
                            .catch(() => []); // On network error, also return an empty array
                    });

                    const results = await Promise.all(filePromises);
                    allRtCallData = results.flat(); // Flatten the array of arrays
                    
                    populateAircraftFilter();
                    renderCalls();
                } catch (error) {
                    console.error('Error processing RT call data:', error);
                    container.innerHTML = '<p style="text-align:center;">Error: Could not process RT call data.</p>';
                }
            }

            function populateAircraftFilter() {
                const allAircraft = new Set();
                allRtCallData.forEach(call => {
                    if (call.aircraft) {
                        call.aircraft.forEach(ac => allAircraft.add(ac));
                    }
                });

                aircraftFilter.innerHTML = '<option value="all">All</option>'; // Reset
                [...allAircraft].sort().forEach(ac => {
                    const option = document.createElement('option');
                    option.value = ac;
                    option.textContent = ac;
                    aircraftFilter.appendChild(option);
                });
            }


            function renderCalls() {
                container.innerHTML = ''; // Clear previous results

                const activeType = document.querySelector('.filter-btn[data-filter-group="type"].active').dataset.filterValue;
                const activeIcao = document.querySelector('.filter-btn[data-filter-group="icao"].active').dataset.filterValue;
                const activeAircraft = aircraftFilter.value;
                const activeCallsign = callsignFilter.value || 'call-sign'; // Use default if empty

                // --- Update Main Title ---
                const displayAircraft = activeAircraft === 'all' ? 'All Aircraft' : activeAircraft.toUpperCase();
                const displayType = activeType.charAt(0).toUpperCase() + activeType.slice(1);
                mainTitle.textContent = `${activeIcao.toUpperCase()} - ${displayAircraft} - {${activeCallsign}} - ${displayType} - RT CALL`;
                // --- End Title Update ---

                const baseFilteredData = allRtCallData.filter(data => {
                    const typeMatch = data.type === activeType;
                    const icaoMatch = data.icao && data.icao.includes(activeIcao.toUpperCase());
                    const aircraftMatch = activeAircraft === 'all' || (data.aircraft && data.aircraft.includes(activeAircraft));

                    return typeMatch && icaoMatch && aircraftMatch;
                });

                // Group the filtered data by category
                const groupedByCategory = baseFilteredData.reduce((acc, call) => {
                    const category = call.category || 'Uncategorized';
                    if (!acc[category]) {
                        acc[category] = [];
                    }
                    acc[category].push(call);
                    return acc;
                }, {});

                // Get the unique categories while preserving the order from the source file
                const orderedCategories = [];
                const categorySet = new Set();
                baseFilteredData.forEach(call => {
                    const category = call.category || 'Uncategorized';
                    if (!categorySet.has(category)) {
                        categorySet.add(category);
                        orderedCategories.push(category);
                    }
                });

                if (orderedCategories.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No matching RT calls found.</p>';
                    return;
                }

                const createCard = (data, index) => {
                    const card = document.createElement('div');
                    card.className = 'rt-card';

                    // Dynamically replace placeholders based on the selected airport
                    const processedCalls = data.calls.map(call => {
                        let { speaker, message } = call;
                        const callsignRegex = /{Call Sign}/gi;

                        if (activeIcao === 'vghs') {
                            message = message.replace(/{GRD}|{GND}/g, '{DHK GRD}').replace(/{TWR}/g, '{DHK TWR}');
                        } else if (activeIcao === 'vgjr') {
                            message = message.replace(/{GRD}|{GND}/g, '{JSR GRD}').replace(/{TWR}/g, '{JSR TWR}');
                        }
                        message = message.replace(callsignRegex, `{${activeCallsign}}`);

                        // For pilot calls, wrap variables in a span to style them differently
                        if (speaker === 'Pilot') {
                            const variableRegex = /({[^}]+})/g;
                            message = message.replace(variableRegex, `<span class="call-variable">${'$&'}</span>`);
                        }

                        return { speaker, message };
                    });


                    const dialogueRows = processedCalls.map(call => `
                        <div class="call-row" data-speaker="${call.speaker}">
                            <span class="speaker">${call.speaker}:</span>
                            <p class="call-text">${call.message || '...'}</p>
                        </div>
                    `).join('');


                    const aircraftListItems = data.aircraft ? data.aircraft.map(ac => `<li>${ac}</li>`).join('') : '<li>N/A</li>';
                    const aircraftPopupId = `aircraft-popup-${index}`;
                    const descPopupId = `desc-popup-${index}`;

                    card.innerHTML = `
                        <div class="phase-column">
                            <h2>${(data.phase || 'N/A').replace(/_/g, ' ')}</h2>
                            <div class="action-btn-group">
                                <button class="aircraft-btn" data-popup-target="#${aircraftPopupId}" title="View Applicable Aircraft">
                                    <i class="fa-solid fa-plane"></i>
                                </button>
                                <button class="description-btn" data-popup-target="#${descPopupId}" title="View Description">
                                    <i class="fa-solid fa-circle-info"></i>
                                </button>
                            </div>
                        </div>
                        <div class="dialogue-column">
                            ${dialogueRows}
                        </div>
                        <div class="popup-overlay" id="${aircraftPopupId}">
                            <div class="popup-content">
                                <h3>Applicable Aircraft</h3>
                                <ul>${aircraftListItems}</ul>
                            </div>
                        </div>
                        <div class="popup-overlay" id="${descPopupId}">
                            <div class="popup-content">
                                <h3 style="text-transform: capitalize;">${(data.phase || 'Description').replace(/_/g, ' ')}</h3>
                                <p>${data.description || 'No description available.'}</p>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                };

                let globalIndex = 0;
                orderedCategories.forEach(category => {
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.className = 'category-header';
                    categoryHeader.textContent = category.toUpperCase();
                    container.appendChild(categoryHeader);

                    const callsInCategory = groupedByCategory[category];
                    callsInCategory.forEach(callData => {
                        createCard(callData, globalIndex++);
                    });
                });
            }

            function setupEventListeners() {
                // Use event delegation for filter buttons
                document.querySelector('.filter-container').addEventListener('click', (e) => {
                    if (e.target.matches('.filter-btn[data-filter-group]')) {
                        const btn = e.target;
                        const group = btn.dataset.filterGroup;
                        document.querySelectorAll(`.filter-btn[data-filter-group="${group}"]`).forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        renderCalls();
                    }
                });

                aircraftFilter.addEventListener('change', renderCalls);
                callsignFilter.addEventListener('input', renderCalls);

                // Event delegation for popups
                document.body.addEventListener('click', function (e) {
                    if (e.target.matches('.aircraft-btn, .aircraft-btn *, .description-btn, .description-btn *')) {
                        const btn = e.target.closest('.aircraft-btn, .description-btn');
                        const popup = document.querySelector(btn.dataset.popupTarget);
                        if (popup) popup.classList.add('visible');
                    }
                    if (e.target.matches('.popup-overlay')) {
                        e.target.classList.remove('visible');
                    }
                });
            }

            document.getElementById('print-btn').addEventListener('click', () => {
                window.print();
            });

            document.getElementById('help-btn').addEventListener('click', () => {
                document.getElementById('help-popup').classList.add('visible');
            });

            // Initial Load
            fetchAllData().then(setupEventListeners);
        });
    </script>

</body>
</html>